<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print Orders</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const datetimeInput = document.getElementById("expected_datetime");

            function isSecondOrFourthSaturday(date) {
                let day = date.getDay(); // 6 = Saturday
                let dateNum = date.getDate();
                return day === 6 && (dateNum > 7 && dateNum <= 14 || dateNum > 21 && dateNum <= 28);
            }

            function getValidDateTimes() {
                let today = new Date();
                let validDateTimes = [];

                for (let i = 0; validDateTimes.length < 3; i++) {
                    let checkDate = new Date();
                    checkDate.setDate(today.getDate() + i);

                    let day = checkDate.getDay(); // 0 = Sunday, 6 = Saturday

                    if (day === 0 || isSecondOrFourthSaturday(checkDate)) continue; // Skip Sundays & 2nd/4th Saturdays
                    validDateTimes.push(checkDate);
                }

                return validDateTimes;
            }

            function updateDateTimePicker() {
                let validDates = getValidDateTimes();
                let today = new Date();
                let nowHours = today.getHours();
                let nowMinutes = today.getMinutes();

                let minDateTime, maxDateTime;

                // Set min datetime: If today, use current time; else 9:00 AM
                if (validDates[0].toDateString() === today.toDateString()) {
                    let minHours = Math.max(9, nowHours);
                    let minMinutes = minHours === nowHours ? nowMinutes : 0;
                    minDateTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), minHours, minMinutes);
                } else {
                    minDateTime = new Date(validDates[0].getFullYear(), validDates[0].getMonth(), validDates[0].getDate(), 9, 0);
                }

                // Set max datetime: Always 4:30 PM on last valid day
                maxDateTime = new Date(validDates[2].getFullYear(), validDates[2].getMonth(), validDates[2].getDate(), 16, 30);

                // Format min/max datetime for HTML datetime-local input
                function formatDateTime(date) {
                    let year = date.getFullYear();
                    let month = String(date.getMonth() + 1).padStart(2, '0');
                    let day = String(date.getDate()).padStart(2, '0');
                    let hours = String(date.getHours()).padStart(2, '0');
                    let minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${year}-${month}-${day}T${hours}:${minutes}`;
                }

                datetimeInput.min = formatDateTime(minDateTime);
                datetimeInput.max = formatDateTime(maxDateTime);

                // Ensure selected time is within range
                if (datetimeInput.value < datetimeInput.min || datetimeInput.value > datetimeInput.max) {
                    datetimeInput.value = datetimeInput.min;
                }
            }

            datetimeInput.addEventListener("change", updateDateTimePicker);
            updateDateTimePicker(); // Initialize options
        });
    </script>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center mb-4">Print Orders</h2>
        <form action="/print_orders" method="post" enctype="multipart/form-data">
            <!-- Number of Copies -->
            <div class="mb-3">
                <label for="copies" class="form-label">Number of Copies</label>
                <input type="number" class="form-control" id="copies" name="copies" min="1" required>
            </div>

            <!-- Layout -->
            <div class="mb-3">
                <label class="form-label">Layout</label>
                <select class="form-select" name="layout" required>
                    <option value="portrait">Portrait</option>
                    <option value="landscape">Landscape</option>
                </select>
            </div>

            <!-- Print Type -->
            <div class="mb-3">
                <label class="form-label">Print Type</label>
                <select class="form-select" name="print_type" required>
                    <option value="black_white">Black and White</option>
                    <option value="color">Color</option>
                </select>
            </div>

            <!-- Single or Double Sided -->
            <div class="mb-3">
                <label class="form-label">Print Sides</label>
                <select class="form-select" name="print_sides" required>
                    <option value="single">Single Sided</option>
                    <option value="double">Double Sided</option>
                </select>
            </div>

            <!-- Expected Date-Time (Single Field) -->
            <div class="mb-3">
                <label for="expected_datetime" class="form-label">Expected Date & Time</label>
                <input type="datetime-local" class="form-control" id="expected_datetime" name="expected_datetime" required>
            </div>

            <!-- PDF Upload -->
<div class="mb-3 position-relative">
    <label for="pdf_upload" class="form-label">Upload PDF</label>
    <div class="input-group">
        <input type="file" class="form-control" id="pdf_upload" name="pdf_upload" accept=".pdf" required>
        <button type="button" class="btn btn-outline-secondary" id="view_pdf" style="display: none;">
            <i class="fa-solid fa-eye"></i> <!-- Eye Icon -->
        </button>
        <button type="button" class="btn btn-outline-danger" id="cancel_pdf" style="display: none;">
            <i class="fa-solid fa-xmark"></i> <!-- X Icon -->
        </button>
    </div>
</div>

<!-- JavaScript to Handle View & Cancel -->
<script>
document.getElementById("pdf_upload").addEventListener("change", function(event) {
    let file = event.target.files[0];
    let viewButton = document.getElementById("view_pdf");
    let cancelButton = document.getElementById("cancel_pdf");

    if (file) {
        viewButton.style.display = "inline-block";
        cancelButton.style.display = "inline-block";

        // Set view button to open the PDF
        viewButton.onclick = function() {
            let fileURL = URL.createObjectURL(file);
            window.open(fileURL, "_blank");
        };
    }
});

document.getElementById("cancel_pdf").addEventListener("click", function() {
    let fileInput = document.getElementById("pdf_upload");
    fileInput.value = ""; // Reset the file input
    document.getElementById("view_pdf").style.display = "none";
    document.getElementById("cancel_pdf").style.display = "none";
});
</script>

            <!-- Save and Next Button -->
            <button type="submit" class="btn btn-primary">Save and Next</button>
        </form>
    </div>
</body>
</html>
